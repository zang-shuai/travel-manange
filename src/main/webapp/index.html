<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

</head>
<body>
<div id="head">
</div>
<h1 id="name"></h1>
<a href="usserregister.html">用户注册</a>
<a id="register" href="userlogin.html">用户登录</a>
<a id="guider" href="guiderlogin.html">导游登录</a>
<a href="admin.html">进入管理</a>
<button id="noregister" onclick="clearCookie('user')">用户登出</button>
<div id="plans"></div>


<script>

    const pathname = window.document.location.pathname;
    const pa = pathname.substring(0, pathname.substr(1).indexOf('/') + 1);


    function setCookie(cname, cvalue, exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
        var expires = "expires=" + d.toUTCString();
        document.cookie = cname + "=" + cvalue + "; " + expires;
    }

    Date.prototype.format = function (fmt) {
        var o = {
            "M+": this.getMonth() + 1,                 //月份
            "d+": this.getDate(),                    //日
            "h+": this.getHours(),                   //小时
            "m+": this.getMinutes(),                 //分
            "s+": this.getSeconds(),                 //秒
            "q+": Math.floor((this.getMonth() + 3) / 3), //季度
            "S": this.getMilliseconds()             //毫秒
        };
        if (/(y+)/.test(fmt)) {
            fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        }
        for (var k in o) {
            if (new RegExp("(" + k + ")").test(fmt)) {
                fmt = fmt.replace(
                    RegExp.$1, (RegExp.$1.length === 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            }
        }
        return fmt;
    }

    function getCookie(cookieName) {
        var strCookie = document.cookie;
        var arrCookie = strCookie.split("; ");
        for (var i = 0; i < arrCookie.length; i++) {
            var arr = arrCookie[i].split("=");
            if (cookieName === arr[0]) {
                return arr[1];
            }
        }
        return null;
    }

    let date = new Date().format("yyyy-MM-dd");

    function clearCookie(name) {
        setCookie(name, "", -1);
        alert("你正要登出")
        location.reload();
    }

    if (getCookie("user") === null) {
        document.getElementById("register").style.display = "inline";
        document.getElementById("noregister").style.display = "none";
    } else {
        document.getElementById("register").style.display = "none";
        document.getElementById("noregister").style.display = "inline";
        //登录显示：
        document.getElementById("name").innerText = getCookie("user");
        fun1();
    }

    function fun1() {
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.open("GET", "getHeadServlet", true);
        xmlhttp.send();
        xmlhttp.onreadystatechange = function () {
            if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
                //获取服务器的响应结果
                let responseText = xmlhttp.responseText;
                let obj = JSON.parse(responseText); //由JSON字符串转换为JSON对象
                let uhead = obj.uhead;
                document.getElementById("head").innerHTML = "<img height='50px' width='50px' src=" + uhead + ">"
            }
        }
    }

    getAllPlans()

    function getAllPlans() {
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.open("GET", "findAllPlanServlet", true);
        xmlhttp.send();
        xmlhttp.onreadystatechange = function () {
            if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
                //获取服务器的响应结果
                let responseText = xmlhttp.responseText;
                let arr = JSON.parse(responseText); //由JSON字符串转换为JSON对象
                console.log(arr)
                for (let obj in arr) {
                    let look = []
                    let tr = document.createElement("div")
                    let arrElement = arr[obj]
                    let pstartDate = new Date(arrElement["pstartDate"]).format("yyyy-MM-dd")
                    let pendDate = new Date(arrElement["pendDate"]).format("yyyy-MM-dd")
                    if (date < pstartDate) {
                    } else {
                        continue
                    }
                    look.push(arrElement["tname"])
                    look.push(arrElement["gname"])
                    look.push(pstartDate)
                    look.push(pendDate)
                    look.push(arrElement["pprice"])
                    for (let x in look) {
                        let td = document.createElement("div")
                        td.innerHTML = look[x]
                        tr.appendChild(td)
                    }

                    let a = document.createElement("a");
                    // a.href = pa + "/purchaseOrder" + "?" + "pid=" + arrElement["pid"]
                    a.href = pa + "/purchase.html" + "?" + "pid=" + arrElement["pid"]
                    a.innerHTML = "查看详情"
                    let img = document.createElement("img");
                    img.src=arrElement["tourist"]["touristImg"][0]["taddress"]
                    // img.width="100%"
                    // img.height="100%"
                    // img.style="float:left"
                    document.getElementById("plans").appendChild(img);
                    // tr.style="float:none"
                    document.getElementById("plans").appendChild(tr);
                    document.getElementById("plans").appendChild(a);
                    document.getElementById("plans").appendChild(document.createElement("hr"));
                }
            }
        }
    }


</script>

</body>
</html>